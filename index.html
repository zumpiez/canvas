<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Canvas</title>
        <style>
            #canvas
            {
                border: 1px solid black;
            }
        </style>
        <script src="cale.js"></script>
        <script>
            var gameConsole;
            // execute on body load
            function load() {
                var world = new Cale.Entity();

                var graphics = new Cale.Graphics({ canvas: "canvas" });

                world.addComponent({
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("draw", function () {
                            graphics.clear();
                        });
                    } 
                });

                gameConsole = new Cale.Entity();
                Cale.augment(gameConsole, {
                    fps: true,
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("draw", function () {
                            self.publish("draw");
                        });
                    }
                });

                var frames;

                gameConsole.addComponent({
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("draw", function () {
                            if (self.parent.fps) {
                                var fps = ++frames / ((+new Date() -
                                    game.startTime()) / 1000);
                                graphics.text({
                                    text: "fps: " + fps.toFixed(2),
                                    x: 5,
                                    y: 10
                                });
                            }
                        });
                    }
                });
                
                var ball = new Cale.Entity({x:150, y:150});
                Cale.augment(ball, {
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("update", function (gametime) {
                            self.publish("update", gametime);
                        });
                        this.parent.subscribe("draw", function () {
                            self.publish("draw"); 
                        });
                    }
                });

                var inputComponent = new Cale.InputComponent();
                Cale.augment(inputComponent, {
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("update", function () {
                            var keyboard = self.keyboard();
                            if (keyboard.isDown(Cale.Input.Keys.LEFT)) {
                                self.parent.translation.x -= 1;
                            } else if (keyboard.isDown(Cale.Input.Keys.RIGHT)) {
                                self.parent.translation.x += 1;
                            }
                            if (keyboard.isDown(Cale.Input.Keys.UP)) {
                                self.parent.translation.y -= 1;
                            } else if (keyboard.isDown(Cale.Input.Keys.DOWN)){
                                self.parent.translation.y += 1;
                            }
                        });
                    }
                });

                ball.addComponents(inputComponent, {
                    initialize: function () {
                        var self = this;
                        this.parent.subscribe("draw", function () {
                            graphics.arc({
                                x: self.parent.translation.x,
                                y: self.parent.translation.y,
                                radius: 10
                            }).fill();
                        });
                    }
                });

                world.addEntities(gameConsole, ball);

                var game = new Cale.Game({
                    update: function(gameTime) {
                        world.publish("update", gameTime);
                    },
                    draw: function() {
                        world.publish("draw");
                    }
                });

                Cale.on(document.getElementById("start"), "click", function () {
                    frames = 0;
                    game.start();
                });

                Cale.on(document.getElementById("stop"), "click", function () {
                    game.stop();
                });
            }
        </script>
    </head>
    <body onload="load()">
        <div class="controls">
            <input id="start" type="button" value="Start" />
            <input id="stop" type="button" value="Stop" />
        </div>
        <div class="game">
            <canvas id="canvas" width="300" height="300">
            </canvas>
        </div>
    </body>
</html>
