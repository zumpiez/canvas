<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Canvas</title>
        <script src="cale.js"></script>
        <script>
            var gameConsole;

            function load() {
                var frames;

                var game = new Cale.Game({
                    update: function (gametime) {
                        this.world().publish("update", gametime);
                    },
                    draw: function () {
                        this.world().publish("draw", this.graphics());
                    },
                    canvasSize: { width: 300, height: 300 },
                    canvasContainer: document.getElementById("game")
                });

                var drawWorldComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            graphics
                                .clear()
                                .save()
                                .translate({ x: 0, y: graphics.height() })
                                .scale({ x: 1, y: -1 });

                            frames += 1;
                            this.publish("camera.draw", graphics);

                            graphics.restore();
                        });
                    }
                });

                game.world().addComponent(drawWorldComponent);
                var x = 0, y = 0, radius = 0;
                gameConsole = Cale.Component.create({
                    showFps: true,
                    showPos: true,
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            var offsetY = 10;
                            if (this.showFps === true) {
                                graphics.text({
                                    text: "fps: " + this.fps().toFixed(2),
                                    x: 5,
                                    y: offsetY
                                });
                                offsetY += 5;
                            }
                            if (this.showPos === true) {
                                graphics.text({
                                    text: "x: " + x + "y: " + y + "radius: " + radius,
                                    x: 5,
                                    y: offsetY + offsetY
                                });
                                offsetY += 5;
                            }
                        });
                    },
                    fps: function () {
                        return frames / ((+new Date() -
                            game.startTime()) / 1000);
                    },
                    setCameraZoom: function (zoom) {
                        this.publish("camera.zoom", zoom);
                    },
                    setCameraRotation: function (rotation) {
                        this.publish("camera.rotate", rotation);
                    },
                    setCameraTranslation: function (x, y) {
                        this.publish("camera.translate", { x: x, y: y });
                    }
                });

                game.world().addComponent(gameConsole);

                var cameraComponent = new Cale.Camera({ x: 1, y: 1 });

                Cale.augment(cameraComponent, {
                    initialize: function () {
                        this.subscribe("camera.draw", function (graphics) {
                            graphics.save()
                                .translate(this.position())
                                .rotate(this.rotation())
                                .scale(this.zoom());

                            this.publish("entity.draw", graphics);

                            graphics.restore();
                        });
                    }
                });

                game.world().addComponent(cameraComponent);

                var ball = new Cale.Entity();

                Cale.augment(ball, {
                    radius: 10,
                    initialize: function () {
                        this.forward("update");
                        this.forward("entity.draw", "draw");
                    }
                });

                var ballInputComponent = new Cale.InputComponent();

                Cale.augment(ballInputComponent, {
                    initialize: function () {
                        var self = this, keyboard, keys;

                        keyboard = this.keyboard();
                        keys = Cale.Input.Keys;

                        keyboard.onDown(function (e) {
                            switch (e.keyCode) {
                                case keys.A:
                                    // rotate
                                    break;
                                case keys.D:
                                    // rotate
                                    break;
                            }
                        });

                        this.subscribe("update", function () {
                            var translation;

                             if (keyboard.isDown(keys.LEFT)) {
                                 this.publish("input", "left");
                             } else if (keyboard.isDown(keys.RIGHT)) {
                                 this.publish("input", "right");
                             }

                             else if (keyboard.isDown(keys.UP)) {
                                 this.publish("input", "up");
                             }
                             else if (keyboard.isDown(keys.DOWN)) {
                                 this.publish("input", "down");
                             }
                        });
                    }
                });

                ball.addComponent(ballInputComponent);

                var ballMovementComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("input", function (input) {
                            switch (input) {
                                case "left":
                                    this.translation.x -= 1;
                                    this.publish("move");
                                    break;
                                case "right":
                                    this.translation.x += 1;
                                    this.publish("move");
                                    break;
                                case "up":
                                    this.translation.y += 1;
                                    this.publish("move");
                                    // attack
                                    break;
                                case "down":
                                    this.translation.y -= 1;
                                    this.publish("move");
                                    break;
                            }
                        }, this.parent);
                    }
                });

                ball.addComponent(ballMovementComponent);

                var ballCollisionComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("move", function () {
                            var height, width;

                            width = game.graphics().width();

                            if (this.translation.x < 0) {
                                this.translation.x = 0;
                            } else if (this.translation.x + this.radius * 2 >= width) {
                                this.translation.x = (width - this.radius * 2) - 1;
                            }

                            height = game.graphics().height();

                            if (this.translation.y < 0) {
                                this.translation.y = 0;
                            } else if (this.translation.y + this.radius * 2 >= height) {
                                this.translation.y = (height - this.radius * 2) - 1;
                            }
                        }, this.parent);
                    }
                });

                ball.addComponent(ballCollisionComponent);

                var ballDrawComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            graphics.arc({
                                x: this.translation.x + this.radius,
                                y: this.translation.y + this.radius,
                                radius: this.radius
                            }).fill();
                        }, this.parent);
                    }
                });

                ball.addComponent(ballDrawComponent);

                game.world().addEntity(ball);

                Cale.on("start", "click", function () {
                    frames = 0;
                    game.start();
                });

                Cale.on("stop", "click", function () {
                    game.stop();
                });
            }
        </script>
    </head>
    <body onload="load()">
        <div class="controls">
            <input id="start" type="button" value="Start" />
            <input id="stop" type="button" value="Stop" />
        </div>
        <div id="game" class="game" width="300" height="300">
        </div>
    </body>
</html>