<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Canvas</title>
        <style>
            #canvas
            {
                border: 1px solid black;
            }
        </style>
        <script src="cale.js"></script>
        <script>
            var gameConsole, graphics;

            function load() {
                var frames;

                var game = new Cale.Game({
                    update: function (gametime) {
                        world.publish("update", gametime);
                    },
                    draw: function () {
                        world.publish("draw", graphics);
                    },
                    canvasSize: { width: 300, height: 300 },
                    canvasContainer: document.getElementById("game")
                });

                graphics = game.graphics();

                var world = game.world;

                var drawWorldComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            graphics
                                .clear()
                                .save()
                                .translate({ x: 0, y: graphics.height() })
                                .scale({ x: 1, y: -1 });

                            frames += 1;
                            this.publish("camera.draw", graphics);

                            graphics.restore();
                        });
                    }
                });

                world.addComponent(drawWorldComponent);

                gameConsole = Cale.Component.create({
                    showFps: true,
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            var offsetY = 10;
                            if (this.showFps === true) {
                                graphics.text({
                                    text: "fps: " + this.fps().toFixed(2),
                                    x: 5,
                                    y: offsetY
                                });
                                offsetY += 5;
                            }
                        });
                    },
                    fps: function () {
                        return frames / ((+new Date() -
                            game.startTime()) / 1000);
                    },
                    setCameraZoom: function (zoom) {
                        this.publish("camera.zoom", zoom);
                    },
                    setCameraRotation: function (rotation) {
                        this.publish("camera.rotate", rotation);
                    },
                    setCameraTranslation: function (x, y) {
                        this.publish("camera.translate", { x: x, y: y });
                    }
                });

                world.addComponent(gameConsole);

                var cameraComponent = Cale.Component.create({
                    zoom: 1,
                    rotation: 0,
                    translation: { x: 1, y: 1 },
                    initialize: function () {
                        this.subscribe("camera.zoom", function (zoom) {
                            this.zoom = zoom;
                        });

                        this.subscribe("camera.rotate", function (rotation) {
                            this.rotation = rotation;
                        });

                        this.subscribe("camera.translate", function (translation) {
                            this.translation = translation;
                        });

                        this.subscribe("camera.draw", function (graphics) {
                            graphics
                                .save()
                                .translate(this.translation)
                                .rotate(this.rotation)
                                .scale(this.zoom);

                            this.publish("entity.draw", graphics);

                            graphics.restore();
                        });
                    }
                });

                world.addComponent(cameraComponent);

                var ball = new Cale.Entity();

                Cale.augment(ball, {
                    radius: 10,
                    initialize: function () {
                        this.forward("update");
                        this.forward("entity.draw", "draw");
                    }
                });

                var ballInputComponent = new Cale.InputComponent();

                Cale.augment(ballInputComponent, {
                    initialize: function () {
                        var self = this, keyboard, keys;

                        keyboard = this.keyboard();
                        keys = Cale.Input.Keys;

                        keyboard.onDown(function (e) {
                            switch (e.keyCode) {
                                case keys.A:
                                    // rotate
                                    break;
                                case keys.D:
                                    // rotate
                                    break;
                            }
                        });

                        this.subscribe("update", function () {
                            var translation;

                             if (keyboard.isDown(keys.LEFT)) {
                                 this.publish("input", "left");
                             } else if (keyboard.isDown(keys.RIGHT)) {
                                 this.publish("input", "right");
                             }

                             if (keyboard.isDown(keys.UP)) {
                                 this.publish("input", "up");
                             }
                        });
                    }
                });

                ball.addComponent(ballInputComponent);

                var ballMovementComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("input", function (input) {
                            switch (input) {
                                case "left":
                                    this.translation.x -= 1;
                                    this.publish("move");
                                    break;
                                case "right":
                                    this.translation.x += 1;
                                    this.publish("move");
                                    break;
                                case "up":
                                    // attack
                                    break;
                            }
                        }, this.parent);
                    }
                });

                ball.addComponent(ballMovementComponent);

                var ballCollisionComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("move", function () {
                            var height, width;

                            width = graphics.width();

                            if (this.translation.x < this.radius) {
                                this.translation.x = this.radius;
                            } else if (this.translation.x > width - this.radius) {
                                this.translation.x = width - this.radius;
                            }

                            height = graphics.height();

                            if (this.translation.y < this.radius) {
                                this.translation.y = this.radius;
                            }
                        }, this.parent);
                    }
                });

                ball.addComponent(ballCollisionComponent);

                var ballDrawComponent = Cale.Component.create({
                    initialize: function () {
                        this.subscribe("draw", function (graphics) {
                            graphics.arc({
                                x: this.translation.x,
                                y: this.translation.y,
                                radius: this.radius
                            }).fill();
                        }, this.parent);
                    }
                });

                ball.addComponent(ballDrawComponent);

                world.addEntity(ball);

                var game = new Cale.Game({
                    update: function (gametime) {
                        world.publish("update", gametime);
                    },
                    draw: function () {
                        world.publish("draw", graphics);
                    }
                });

                Cale.on("start", "click", function () {
                    frames = 0;
                    game.start();
                });

                Cale.on("stop", "click", function () {
                    game.stop();
                });
            }
        </script>
    </head>
    <body onload="load()">
        <div class="controls">
            <input id="start" type="button" value="Start" />
            <input id="stop" type="button" value="Stop" />
        </div>
        <div id="game" class="game" width="300" height="300">
        </div>
    </body>
</html>
